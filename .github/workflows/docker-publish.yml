name: Docker Build & Publish

permissions:
  contents: read

env:
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/discord-docker-bot

on:
  push:
    branches: [ "main" , "docker-purge-testing" ]
    tags: [ 'v*.*.*' ]
  # Rebuild monthly to pick up base image security updates automatically
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v3
        with:
          python-version: "3.11"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
          
      - name: Run Unit Tests
        env:
          BOT_TOKEN: "test_token_mock"
          ALLOWED_CONTAINERS: "test_container"
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          pytest -v tests/

      - name: Build Docker Image (Smoke Test)
        run: docker build . --file Dockerfile --tag bot-test:latest

      - name: Test Container Startup (Smoke Test)
        run: docker run --rm -e BOT_TOKEN=test_token -e ALLOWED_CONTAINERS=test_container bot-test:latest python -c "import src.bot; print('Container environment is valid')"

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=true
            type=raw,value={{date 'YYYYMMDD'}}
            type=ref,event=tag
            type=sha
            type=schedule,pattern=monthly

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  prune-tags:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Prune old tags
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASS: ${{ secrets.DOCKER_TOKEN }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          KEEP_N: 5
          IGNORE_TAGS: "latest,develop"
          DRY_RUN: false
        run: |
          # 1. Authenticate with Docker Hub to get JWT
          echo "Logging in to Docker Hub..."
          TOKEN=$(curl -s -H "Content-Type: application/json" -X POST -d '{"username": "'${DOCKER_USER}'", "password": "'${DOCKER_PASS}'"}' https://hub.docker.com/v2/users/login/ | jq -r .token)

          if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
            echo "::error::Failed to authenticate with Docker Hub."
            exit 1
          fi

          # 2. Fetch tags (limit 100, usually sufficient for retention policies)
          # Sorted by last_updated descending so we process newest first
          echo "Fetching tags for $IMAGE_NAME (sorted by date)..."
          TAGS=$(curl -s -H "Authorization: JWT ${TOKEN}" "https://hub.docker.com/v2/repositories/${IMAGE_NAME}/tags/?page_size=100&ordering=-last_updated" | jq -r '.results[].name')

          # 3. Filter out ignored tags
          # Convert comma-separated IGNORE_TAGS to regex alternation (e.g., "latest|develop")
          IGNORE_REGEX="^($(echo "$IGNORE_TAGS" | tr ',' '|'))$"
          CANDIDATE_TAGS=$(echo "$TAGS" | grep -vE "$IGNORE_REGEX" || true)
          
          # Skip the first N tags (keep-last)
          TAGS_TO_DELETE=$(echo "$CANDIDATE_TAGS" | tail -n +$(($KEEP_N + 1)))

          if [ -z "$TAGS_TO_DELETE" ]; then
            echo "No tags found to delete (keeping latest $KEEP_N)."
            exit 0
          fi

          echo "Found tags to delete:"
          echo "$TAGS_TO_DELETE"

          # 4. Delete tags
          for TAG in $TAGS_TO_DELETE; do
            if [ "$DRY_RUN" = "true" ]; then
              echo "[DRY RUN] Would delete: $TAG"
            else
              echo "Deleting $TAG..."
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE -H "Authorization: JWT ${TOKEN}" "https://hub.docker.com/v2/repositories/${IMAGE_NAME}/tags/${TAG}/")
              if [ "$HTTP_CODE" -eq 204 ]; then
                echo "✅ Deleted $TAG"
              else
                echo "❌ Failed to delete $TAG (HTTP $HTTP_CODE)"
              fi
            fi
          done
        